<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Plus - Admin Panel</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    /* Navbar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #003366;
      padding: 15px 40px;
      color: white;
    }

    .navbar .logo {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .navbar ul {
      list-style: none;
      display: flex;
      margin: 0;
      padding: 0;
      align-items: center;
    }

    .navbar ul li {
      margin: 0 15px;
    }

    .navbar ul li a {
      text-decoration: none;
      color: white;
      font-size: 16px;
    }

    .navbar ul li a:hover {
      text-decoration: underline;
    }

    .navbar button {
      background: transparent;
      border: 2px solid white;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
    }

    .navbar button:hover {
      background: white;
      color: #003366;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }

    h1 {
      color: #003366;
      text-align: center;
      margin-bottom: 30px;
    }

    /* Section Cards */
    .section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }

    .section h2 {
      color: #003366;
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid #cce0ff;
      padding-bottom: 10px;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      color: #003366;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #cce0ff;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #004080;
    }

    button {
      background: #004080;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
    }

    button:hover {
      background: #0059b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-danger {
      background: #dc3545;
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-warning {
      background: #ffc107;
      padding: 8px 16px;
      font-size: 13px;
      color: #000;
      margin-right: 8px;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    /* File List */
    .file-list {
      margin-top: 15px;
      padding: 10px;
      background: white;
      border-radius: 5px;
    }

    .file-item {
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
    }

    .file-info {
      flex-grow: 1;
    }

    .file-name {
      font-weight: bold;
      color: #004080;
      margin-bottom: 4px;
    }

    .file-meta {
      font-size: 12px;
      color: #666;
    }

    .file-actions {
      display: flex;
      gap: 8px;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      display: block;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .empty {
      text-align: center;
      padding: 30px;
      color: #999;
      font-style: italic;
    }

    .refresh-btn {
      background: #17a2b8;
      padding: 8px 16px;
      font-size: 13px;
      margin-left: 10px;
    }

    .refresh-btn:hover {
      background: #138496;
    }

    .user-info {
      font-size: 13px;
      color: #cce0ff;
      margin-left: 20px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      color: #003366;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .device-card {
      background: #f8f9fa;
      border: 2px solid #cce0ff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .device-card h3 {
      margin: 0 0 10px 0;
      color: #003366;
      font-size: 20px;
    }

    .device-path {
      color: #666;
      font-size: 13px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <div class="logo">TEAM PLUS ADMIN</div>
  <div style="display: flex; align-items: center;">
    <span class="user-info" id="userInfo">üë§ Loading...</span>
    <ul>
      <li><a href="firmware-select.html">Dashboard</a></li>
      <li><a href="admin.html">Admin Panel</a></li>
      <li><button onclick="adminLogout()">Logout</button></li>
    </ul>
  </div>
</div>

<div class="container">
  <h1>üîß Firmware Management Portal</h1>

  <!-- Messages -->
  <div id="messageContainer"></div>

  <!-- Select Device Section -->
  <div class="section">
    <h2>üì± Select Device</h2>
    <div class="form-group">
      <label for="deviceSelect">Choose Device Type:</label>
      <select id="deviceSelect" onchange="loadDeviceFiles()">
        <option value="">-- Select a device --</option>
        <option value="CANGate">CANGate ‚Äì Firmware Update Packages</option>
        <option value="Wheel-Turtle-Club">Wheel Turtle Club (Battery Powered Model)</option>
        <option value="Wheel-Turtle-PRO">Wheel Turtle PRO (Hard Wired Model)</option>
        <option value="Brake-Turtle-PRO">Brake Turtle PRO</option>
        <option value="Telelogger">Telelogger</option>
      </select>
    </div>
  </div>

  <!-- Upload File Section -->
  <div class="section" id="uploadSection" style="display:none;">
    <h2>üì§ Upload Firmware File</h2>
    <form id="uploadFileForm">
      <div class="form-group">
        <label for="fileUpload">Choose File (.bin only):</label>
        <input 
          type="file" 
          id="fileUpload" 
          accept=".bin" 
          required
        >
        <small style="color: #666;">Max file size: 50MB</small>
      </div>
      <button type="submit" id="uploadBtn">Upload File</button>
      <div id="uploadProgress" style="margin-top: 10px; display: none;">
        <div style="background: #e9ecef; border-radius: 5px; height: 20px; overflow: hidden;">
          <div id="uploadProgressBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <small id="uploadProgressText">Uploading...</small>
      </div>
    </form>
  </div>

  <!-- Manage Files Section -->
  <div class="section" id="filesSection" style="display:none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">üìÇ Current Files</h2>
      <button class="refresh-btn" onclick="loadDeviceFiles()">üîÑ Refresh</button>
    </div>
    
    <div class="device-card" id="deviceCard">
      <h3 id="deviceTitle">Device Name</h3>
      <div class="device-path" id="devicePath">Path: public/firmware/</div>
    </div>

    <div id="filesLoading" class="loading">Loading files...</div>
    <div id="filesList" class="file-list"></div>
  </div>
</div>

<!-- Rename File Modal -->
<div id="renameModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">‚úèÔ∏è Rename File</div>
    <div class="modal-body">
      <div class="form-group">
        <label for="newFileName">New File Name:</label>
        <input 
          type="text" 
          id="newFileName" 
          placeholder="Enter new filename (must end with .bin)"
        >
        <small style="color: #666; display: block; margin-top: 5px;">
          Current: <span id="currentFileName" style="font-weight: bold;"></span>
        </small>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeRenameModal()">Cancel</button>
      <button onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<script>
/* ========================================
   AUTHENTICATION CHECK
   ======================================== */
const API_BASE = 'http://localhost:3000';

async function checkAdminAuth() {
  const token = localStorage.getItem('authToken');
  const role = localStorage.getItem('userRole');
  const email = localStorage.getItem('userEmail');
  
  // Display user info
  const userInfo = document.getElementById('userInfo');
  if (email) {
    userInfo.textContent = `üë§ ${email}`;
  }
  
  if (!token || role !== 'admin') {
    alert('üîí Admin login required. Redirecting to login page...');
    window.location.href = 'admin-login.html';
    return false;
  }

  try {
    const resp = await fetch(`${API_BASE}/auth/verify-token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });

    const data = await resp.json();

    if (!data.valid || data.role !== 'admin') {
      localStorage.removeItem('authToken');
      localStorage.removeItem('userRole');
      localStorage.removeItem('userEmail');
      alert('‚ö†Ô∏è Session expired or invalid. Please login again.');
      window.location.href = 'admin-login.html';
      return false;
    }
    
    console.log('‚úì Admin authenticated:', data.email);
    return true;
  } catch (err) {
    console.error('Auth check error:', err);
    return true;
  }
}

// Logout function
function adminLogout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userEmail');
    alert('‚úì Logged out successfully');
    window.location.href = 'admin-login.html';
  }
}

/* ========================================
   ADMIN PANEL FUNCTIONALITY
   ======================================== */

// DOM Elements
const uploadFileForm = document.getElementById('uploadFileForm');
const messageContainer = document.getElementById('messageContainer');
const uploadProgress = document.getElementById('uploadProgress');
const uploadProgressBar = document.getElementById('uploadProgressBar');
const uploadProgressText = document.getElementById('uploadProgressText');
const renameModal = document.getElementById('renameModal');
const newFileNameInput = document.getElementById('newFileName');
const currentFileNameSpan = document.getElementById('currentFileName');
const deviceSelect = document.getElementById('deviceSelect');
const uploadSection = document.getElementById('uploadSection');
const filesSection = document.getElementById('filesSection');
const deviceTitle = document.getElementById('deviceTitle');
const devicePath = document.getElementById('devicePath');
const filesList = document.getElementById('filesList');
const filesLoading = document.getElementById('filesLoading');

// State
let selectedDevice = '';
let renameFileData = { directory: '', oldName: '' };

// Device name mapping
const deviceNames = {
  'CANGate': 'CANGate ‚Äì Firmware Update Packages',
  'Wheel-Turtle-Club': 'Wheel Turtle Club (Battery Powered Model)',
  'Wheel-Turtle-PRO': 'Wheel Turtle PRO (Hard Wired Model)',
  'Brake-Turtle-PRO': 'Brake Turtle PRO',
  'Telelogger': 'Telelogger'
};

// Utility Functions
function showMessage(msg, type = 'success') {
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${type}`;
  msgDiv.textContent = msg;
  messageContainer.innerHTML = '';
  messageContainer.appendChild(msgDiv);
  
  setTimeout(() => {
    msgDiv.style.display = 'none';
  }, 5000);
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function humanSize(bytes) {
  if (!bytes) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB'];
  let i = 0;
  let size = bytes;
  while (size >= 1024 && i < units.length - 1) {
    size /= 1024;
    i++;
  }
  return `${size.toFixed(1)} ${units[i]}`;
}

// Load Device Files
async function loadDeviceFiles() {
  selectedDevice = deviceSelect.value;
  
  if (!selectedDevice) {
    uploadSection.style.display = 'none';
    filesSection.style.display = 'none';
    return;
  }

  // Show sections
  uploadSection.style.display = 'block';
  filesSection.style.display = 'block';

  // Update device info
  deviceTitle.textContent = `üìÅ ${deviceNames[selectedDevice]}`;
  devicePath.textContent = `Path: public/firmware/${selectedDevice}`;

  // Load files
  try {
    filesLoading.style.display = 'block';
    filesList.innerHTML = '';

    const response = await fetch(`${API_BASE}/api/files?directory=${encodeURIComponent(selectedDevice)}`);
    const data = await response.json();

    filesLoading.style.display = 'none';

    if (data.ok && data.files.length > 0) {
      const binFiles = data.files.filter(file => file.name.endsWith('.bin'));
      
      if (binFiles.length > 0) {
        binFiles.forEach(file => {
          const fileDiv = createFileItem(file);
          filesList.appendChild(fileDiv);
        });
        console.log(`Loaded ${binFiles.length} firmware file(s)`);
      } else {
        filesList.innerHTML = '<div class="empty">üì≠ No .bin files found in this device</div>';
      }
    } else {
      filesList.innerHTML = '<div class="empty">üì≠ No files found. Upload firmware files above.</div>';
    }
  } catch (error) {
    filesLoading.style.display = 'none';
    filesList.innerHTML = '<div class="empty" style="color:#dc3545;">‚ùå Error loading files</div>';
    console.error('Error loading files:', error);
  }
}

// Create File Item
function createFileItem(file) {
  const fileDiv = document.createElement('div');
  fileDiv.className = 'file-item';

  const fileInfo = document.createElement('div');
  fileInfo.className = 'file-info';

  const fileName = document.createElement('div');
  fileName.className = 'file-name';
  fileName.textContent = file.name;

  const fileMeta = document.createElement('div');
  fileMeta.className = 'file-meta';
  fileMeta.textContent = `Size: ${humanSize(file.size)} | Modified: ${new Date(file.modified).toLocaleString()}`;

  fileInfo.appendChild(fileName);
  fileInfo.appendChild(fileMeta);

  const fileActions = document.createElement('div');
  fileActions.className = 'file-actions';

  const renameBtn = document.createElement('button');
  renameBtn.className = 'btn-warning';
  renameBtn.textContent = '‚úèÔ∏è Rename';
  renameBtn.onclick = () => openRenameModal(selectedDevice, file.name);

  const deleteFileBtn = document.createElement('button');
  deleteFileBtn.className = 'btn-danger';
  deleteFileBtn.textContent = 'üóëÔ∏è Delete';
  deleteFileBtn.onclick = () => deleteFile(selectedDevice, file.name);

  fileActions.appendChild(renameBtn);
  fileActions.appendChild(deleteFileBtn);

  fileDiv.appendChild(fileInfo);
  fileDiv.appendChild(fileActions);

  return fileDiv;
}

// Upload File
uploadFileForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!selectedDevice) {
    showMessage('‚ùå Please select a device first', 'error');
    return;
  }

  const fileInput = document.getElementById('fileUpload');
  const file = fileInput.files[0];

  if (!file) {
    showMessage('‚ùå Please select a file', 'error');
    return;
  }

  if (!file.name.endsWith('.bin')) {
    showMessage('‚ùå Only .bin files are allowed', 'error');
    return;
  }

  const formData = new FormData();
  formData.append('directory', selectedDevice);
  formData.append('file', file);

  const uploadBtn = document.getElementById('uploadBtn');
  uploadBtn.disabled = true;
  uploadBtn.textContent = 'Uploading...';
  uploadProgress.style.display = 'block';

  try {
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        uploadProgressBar.style.width = percent + '%';
        uploadProgressText.textContent = `Uploading: ${Math.round(percent)}%`;
      }
    });

    xhr.addEventListener('load', async () => {
      if (xhr.status === 200) {
        try {
          const data = JSON.parse(xhr.responseText);
          if (data.ok) {
            showMessage(`‚úÖ File "${file.name}" uploaded successfully!`, 'success');
            uploadFileForm.reset();
            await loadDeviceFiles();
          } else {
            showMessage(`‚ùå Upload failed: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (parseError) {
          showMessage('‚ùå Error parsing server response', 'error');
        }
      } else {
        showMessage(`‚ùå Upload failed: HTTP ${xhr.status}`, 'error');
      }
      
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload File';
      uploadProgress.style.display = 'none';
      uploadProgressBar.style.width = '0%';
    });

    xhr.addEventListener('error', () => {
      showMessage('‚ùå Network error during upload', 'error');
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload File';
      uploadProgress.style.display = 'none';
    });

    xhr.open('POST', `${API_BASE}/api/upload`);
    xhr.send(formData);

  } catch (error) {
    showMessage('‚ùå Upload error', 'error');
    console.error(error);
    uploadBtn.disabled = false;
    uploadBtn.textContent = 'Upload File';
    uploadProgress.style.display = 'none';
  }
});

// Rename File Functions
function openRenameModal(directory, filename) {
  renameFileData = { directory, oldName: filename };
  currentFileNameSpan.textContent = filename;
  newFileNameInput.value = filename;
  renameModal.style.display = 'block';
  
  setTimeout(() => {
    newFileNameInput.focus();
    const dotIndex = filename.lastIndexOf('.');
    if (dotIndex > 0) {
      newFileNameInput.setSelectionRange(0, dotIndex);
    }
  }, 100);
}

function closeRenameModal() {
  renameModal.style.display = 'none';
  renameFileData = { directory: '', oldName: '' };
  newFileNameInput.value = '';
}

async function confirmRename() {
  const newName = newFileNameInput.value.trim();
  
  if (!newName) {
    alert('‚ùå Please enter a new filename');
    return;
  }

  if (!newName.endsWith('.bin')) {
    alert('‚ùå Filename must end with .bin extension');
    return;
  }

  if (newName === renameFileData.oldName) {
    alert('‚ùå New filename is the same as the old one');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/api/files/rename`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        directory: renameFileData.directory,
        oldName: renameFileData.oldName,
        newName: newName
      })
    });

    const data = await response.json();

    if (data.ok) {
      showMessage(`‚úÖ File renamed from "${renameFileData.oldName}" to "${newName}"`, 'success');
      closeRenameModal();
      await loadDeviceFiles();
    } else {
      showMessage(`‚ùå ${data.error}`, 'error');
    }
  } catch (error) {
    showMessage('‚ùå Network error renaming file', 'error');
    console.error(error);
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  if (event.target === renameModal) {
    closeRenameModal();
  }
}

// Delete File
async function deleteFile(directory, filename) {
  if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis action cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/api/files`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ directory, filename })
    });

    const data = await response.json();

    if (data.ok) {
      showMessage(`‚úÖ File "${filename}" deleted successfully!`, 'success');
      await loadDeviceFiles();
    } else {
      showMessage(`‚ùå ${data.error}`, 'error');
    }
  } catch (error) {
    showMessage('‚ùå Network error deleting file', 'error');
    console.error(error);
  }
}

/* ========================================
   INITIALIZE
   ======================================== */
checkAdminAuth().then(isAuthenticated => {
  if (!isAuthenticated) return;
  console.log('Admin authenticated successfully');
});
</script>

</body>
</html>
